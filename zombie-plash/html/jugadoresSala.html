<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="js/cancelarLetra.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/jugadoresSala.css"><link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <title>Crea tu sala</title>
</head>
<body>
    <div class="container-fluid">
        <div class="imagen">
            <div class="cuadro">
                <div class="row">
                    <div class="col linia">ID Sala</div>
                    <div class="col contenedor" id="idSala"></div>
                    <div class="col linia">Jugadores conectados</div>
                    <div class="col contenedor" id="jugadoresConectados"></div>
                    <div class="col">
                        <button type="button" class="boton"><strong>Jugar</strong></button>
                    </div>
                </div>
                <div class="row">
                    <div class="col ci">
                        <i class="bi bi-person-add icono"></i>
                    </div>
                    <div class="col contenedor quitar"></div>
                    <div class="col linia">Contraseña</div>
                    <div class="col contenedor" id="contraseñaSala"></div>
                    <div class="col">
                        <button type="button" class="botonrojo" onclick="cancelarSala()"><strong>Cancelar sala</strong></button>
                        <!-- boton para devolver al inicio del juego -->
                        <button type="button" class="botonrojo" onclick="window.location.href='./inicio.php'"><strong>salir</strong></button>
                
                    </div>
                </div>
                <div class="titulo"><strong>Jugadores en la sala</strong></div>
                <div class="row1" id="circulosJugadores">
                    <div class="col2"><div class="circulo"></div></div>
                    <div class="col2"><div class="circulo"></div></div>
                    <div class="col2"><div class="circulo"></div></div>
                    <div class="col2"><div class="circulo"></div></div>
                    <div class="col2"><div class="circulo"></div></div>
                </div>
                <div class="row2" id="nombresJugadores">
                    <div class="col2">Esperando jugador...</div>
                    <div class="col2">Esperando jugador...</div>
                    <div class="col2">Esperando jugador...</div>
                    <div class="col2">Esperando jugador...</div>
                    <div class="col2">Esperando jugador...</div>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const datosSala = JSON.parse(localStorage.getItem('datosSala'));

        if (datosSala) {
            document.getElementById('idSala').textContent = datosSala.id_sala;
            document.getElementById('jugadoresConectados').textContent = datosSala.jugadores_conectados + '/' + datosSala.max_jugadores;
            document.getElementById('contraseñaSala').textContent = datosSala.contraseña_sala;

            // Función para actualizar la lista de jugadores
            function actualizarJugadores() {
                fetch('../php/obtenerJugadoresSala.php?id_sala=' + datosSala.id_sala)
                    .then(response => response.json())
                    .then(jugadores => {
                        console.log("Jugadores recibidos:", jugadores);
                        const circulosJugadores = document.getElementById('circulosJugadores').children;
                        const nombresJugadores = document.getElementById('nombresJugadores').children;

                        // Actualizar cada posición de jugador
                        for (let i = 0; i < circulosJugadores.length; i++) {
                            const circulo = circulosJugadores[i].querySelector('.circulo');
                            const nombreElement = nombresJugadores[i];

                            if (i < jugadores.length) {
                                // Jugador conectado
                                circulo.style.backgroundColor = '#00ff00'; // Verde para jugadores conectados
                                nombreElement.textContent = jugadores[i].nombre_jugador;
                                console.log(`Actualizando jugador ${i}: ${jugadores[i].nombre_jugador}`);
                            } else {
                                // Espacio vacío
                                circulo.style.backgroundColor = '#ff0000'; // Rojo para espacios vacíos
                                nombreElement.textContent = 'Esperando jugador...';
                                console.log(`Posición ${i}: Esperando jugador`);
                            }
                        }

                        // Actualizar el contador de jugadores conectados
                        document.getElementById('jugadoresConectados').textContent = jugadores.length + '/' + datosSala.max_jugadores;
                    })
                    .catch(error => {
                        console.error('Error al obtener jugadores:', error);
                    });
            }

            // Actualizar jugadores inmediatamente y cada 5 segundos
            actualizarJugadores();
            setInterval(actualizarJugadores, 5000);
        }
    });

    function cancelarSala() {
        const datosSala = JSON.parse(localStorage.getItem('datosSala'));
        console.log('Datos de la sala:', datosSala); // Añade este log
        if (datosSala && datosSala.id_sala) {
            if (confirm('¿Estás seguro de que quieres cancelar la sala?')) {
                fetch('../php/cancelarSala.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id_sala: datosSala.id_sala })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('La sala ha sido cancelada exitosamente.');
                        localStorage.removeItem('datosSala');
                        window.location.href = 'inicio.php'; // Redirige al usuario a la página de inicio
                    } else {
                        alert('Error al cancelar la sala: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ocurrió un error al intentar cancelar la sala.');
                });
            }
        } else {
            alert('No se encontraron datos de la sala.');
        }
    }
    </script>
</body>
</html>
